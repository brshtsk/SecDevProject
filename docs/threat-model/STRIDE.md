# STRIDE — Угрозы и контроли

STRIDE: S — Spoofing, T — Tampering, R — Repudiation, I — Information disclosure, D — Denial of service, E —
Elevation of privilege

| Поток/Элемент                             | Угроза (S/T/R/I/D/E) | Описание угрозы                                              | Контроль                                                             | Ссылка на NFR  | Проверка/Артефакт                                                                |
|-------------------------------------------|----------------------|--------------------------------------------------------------|----------------------------------------------------------------------|----------------|----------------------------------------------------------------------------------|
| F1: User → API (логин/регистрация)        | S                    | Подмена личности при аутентификации, подбор пароля           | Хэширование паролей в БД, ограничение TTL токена                     | NFR-01, NFR-03 | Код: `app/auth.py`; Тесты: `::test_login_success`                                |
| F2: API → User (выдача JWT)               | I                    | Утечка токена в ответах/логах, чрезмерные привилегии         | Минимальный JWT payload (`sub`, `exp`), не логировать секреты/токены | NFR-02, NFR-03 | Код: `app/auth.py`; Тесты: `scripts/check_secret_policy.py`                      |
| F3: User → API (CRUD/голоса)              | R                    | Отрицание действий пользователем                             | Аудит ключевых событий (логин/CRUD)                                  | NFR-11         | Требуется логирование и хранение 90 дней                                         |
| F3: User → API (CRUD/голоса)              | D                    | DoS: перегрузка API частыми запросами                        | Rate limiting на POST                                                | NFR-06         | Требуется лимит в 10 req/min/IP                                                  |
| F3: User → API (CRUD/голоса)              | T                    | Подмена/некорректный payload, обход валидации                | Pydantic-схемы                                                       | NFR-04         | Тесты: `::test_validation_error`; Код: `app/main.py`                             |
| F5: API ↔ Auth (верификация)              | T                    | Изменение логики верификации пароля/токена                   | Негативные тесты, whitelisting алгоритма JWT                         | NFR-04         | Тесты: `::test_login_invalid_credentials`; Код: `app/auth.py`                    |
| F6: API ↔ Service (операции идей/голосов) | E                    | Повышение привилегий: изменение/удаление чужих идей          | Контроль владения (owner-only) для PUT/DELETE                        | NFR-07         | Код: `app/crud/crud_ideas.py::update_idea`; Тест: `::test_forbidden_idea_update` |
| F6: API ↔ Service (голоса)                | T                    | Многократное голосование одним пользователем                 | Идемпотентность по (user, idea): обновление существующего голоса     | —              | Код: `app/crud/crud_ideas.py::vote_idea`; Тест: `::test_vote_for_idea`           |
| F7: Service ↔ DB (SQL/TCP)                | I                    | Утечка хэшей паролей/PII из БД                               | Хранить только хэши, не логировать содержимое записей                | NFR-01         | Код: `app/crud/crud_users.py`                                                    |
| F7: Service ↔ DB (SQL/TCP)                | T                    | SQL Injection через сырые запросы/непараметризованные данные | Использование ORM SQLAlchemy; запрет сырых `.execute()`              | —              | Ревью/линтеры; CI SAST                                                           |
| F8: API → Secrets (ENV/volume)            | I                    | Утечка секретов (SECRET_KEY, DATABASE_URL) в репо/логи       | Секреты только из окружения; скан секретов в CI                      | NFR-02, NFR-09 | Скрипт: `scripts/check_secret_policy.py`                                         |
| Элемент: CORS-политика                    | I/E                  | `*` + credentials → кража токенов через браузер              | Жёсткий список ORIGINS из `.env`; запрет `credentials` при `*`       | NFR-05         | Код: `app/main.py`;                                                              |
| Элемент: OpenAPI в prod                   | I/E                  | Открытая `/docs` упрощает разведку атак                      | Отключить/защитить `/docs` в prod через ENV-гейт                     | NFR-12         | Конфиг: FastAPI `docs_url=None` в prod                                           |
