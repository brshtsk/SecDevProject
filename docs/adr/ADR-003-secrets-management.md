# ADR-003: Управление секретами

Дата: 21.10.2025
Статус: Accepted

## Context

Секреты необходимы для работы сервиса, но их утечка или хранение в
коде/логах приводит к серьезным инцидентам. Нужно определить единую стратегию работы с секретами.

Альтернативы:

- Хранить в репозитории зашифрованными - высокие требования к ключам и процессам
- Хранить только в GitHub Secrets - не подходит для runtime
- Использовать secret management system (vault) - предпочтительный вариант

## Decision

1. Источник секретов
    - В рантайме приложение берет секреты только из окружения (`ENV`) или из специального secret-provider (vault)
2. Fail-fast
    - Приложение при старте проверяет обязательные секреты (например, `SECRET_KEY`, `DATABASE_URL`). При отсутствии —
      приложение завершается с ненулевым кодом и логгирует короткое сообщение
3. Ротация и TTL
    - Политика ротации `SECRET_KEY` (и других долгоживущих секретов): **≤ 90 дней**
4. Запрет на логирование/коммит
    - В коде категорически запрещено хардкодить секреты. Нахождение секретов - fail build в CI
    - Логи не должны содержать секретов

## Consequences

Плюсы:

- Снижает вероятность утечки секретов в репозитории и логах
- Обеспечивает готовность к регулярной ротации

Минусы:

- Требуется поддержка secret-provider (vault)
- Ротация секретов увеличивает операционную сложность

## Links

- NFR-02 (JWT secret and rotation), NFR-09 (secrets scanning)
- R3 (Отсутствие/слабый SECRET_KEY и ротация) - ADR закрывает риск при условии наличие CI check и fail-fast при старте
- scripts/check_secret_policy.py
- tests/test_secrets.py::test_fail_fast_missing_required_secret
- tests/test_secrets.py::test_secret_not_present_in_logs
