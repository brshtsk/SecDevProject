# ADR-002: Переход к формату RFC 7807

Дата: 21.10.2025
Статус: Accepted

## Context

В проекте требуется единообразный формат ошибок для всех HTTP-эндпоинтов. Без
стандартизации ошибки раскрывают внутренние детали и усложняют работу.

Альтернативы:

- Использовать собственные JSON-форматы для каждого handler - приводит к разрозненности
- Не использовать JSON-формат вообще - усложняет клиентскую обработку
- Внедрить RFC 7807 - предпочтительный вариант

## Decision

1. Внедряем RFC 7807 как обязательный контракт ответа об ошибках API
2. Поля response-body (JSON):
    - `type` - URI ошибки
    - `title` - название ошибки
    - `status` - HTTP
    - `detail` - описание
    - `correlation_id` - идентификатор для поиска в логах
    - `errors` - каталог ошибок
3. Маскирование деталей
    - Internal errors (500) не должны раскрывать внутренние детали
4. Заголовки
    - Ответы с Problem Details должны использовать `Content-Type: application/problem+json`
5. Контрактные проверки
    - Контракт проверяется тестами (см. `tests/tests_errors.py`)

## Consequences

Плюсы:

- Упрощает клиентскую обработку ошибок и автоматизацию
- Обеспечивает единый способ корреляции инцидентов

Минусы:

- Требуется небольшая доработка middleware и тестов

## Links

- NFR-04 (Формат ошибок: единый JSON-конверт, без утечки PII)
- F2 (API -> User (выдача JWT))
- R3 (отсутствие SECRET_KEY) — пример ошибки конфигурации, которая должна быть fail-fast
- test/tests_errors.py::test_validation_problem_details
- test/tests_errors.py::test_internal_error_masks_details
